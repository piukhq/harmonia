#! /bin/bash

TRANS_ID=$(uuidgen | tr '[:lower:]' '[:upper:]' | base64)
echo "transaction id: ${TRANS_ID}"

read -r -d '' PAYLOAD <<EOF
{"CardId": "ODBBQjBGMDctNjBENC00RTY0LThGNTctMTg5QjI4NDY0OEND", "ExternalUserId": "Q8rNN8ZYS/S+dSPojq3sAQ==1", "MessageElementsCollection": [{"Key": "Transaction.MerchantCardAcceptorId", "Value": "02894183"}, {"Key": "Transaction.MerchantAcquirerBin", "Value": "3423432"}, {"Key": "Transaction.TransactionAmount", "Value": "45.67"}, {"Key": "Transaction.VipTransactionId", "Value": "${TRANS_ID}"}, {"Key": "Transaction.VisaMerchantName", "Value": ""}, {"Key": "Transaction.VisaMerchantId", "Value": ""}, {"Key": "Transaction.VisaStoreName", "Value": ""}, {"Key": "Transaction.VisaStoreId", "Value": ""}, {"Key": "Transaction.CurrencyCodeNumeric", "Value": "840"}, {"Key": "Transaction.BillingCurrencyCode", "Value": "840"}, {"Key": "Transaction.USDAmount", "Value": "45.67"}, {"Key": "Transaction.MerchantLocalPurchaseDate", "Value": "2020-11-03"}, {"Key": "Transaction.MerchantGroup.0.Name", "Value": "ICELAND-BONUS-CARD"}, {"Key": "Transaction.MerchantGroup.0.ExternalId", "Value": "Iceland"}, {"Key": "Transaction.AuthCode", "Value": "778595"}, {"Key": "Transaction.PanLastFour", "Value": "4242"}, {"Key": "Transaction.MerchantDateTimeGMT", "Value": "2020-11-03 11:13:57"}, {"Key": "Transaction.BillingAmount", "Value": "45.67"}, {"Key": "Transaction.TimeStampYYMMDD", "Value": "2020-11-03 11:13:57"}, {"Key": "Transaction.SettlementDate", "Value": ""}, {"Key": "Transaction.SettlementAmount", "Value": "0"}, {"Key": "Transaction.SettlementCurrencyCodeNumeric", "Value": "0"}, {"Key": "Transaction.SettlementBillingAmount", "Value": "0"}, {"Key": "Transaction.SettlementBillingCurrency", "Value": ""}, {"Key": "Transaction.SettlementUSDAmount", "Value": "0"}], "MessageId": "9BCACF23-C399-4AE7-A391-5D9C792AEDES", "MessageName": "AuthMessageTest", "UserDefinedFieldsCollection": [{"Key": "TransactionType", "Value": "Auth"}], "UserProfileId": "9743FFB0-39F9-4004-8D26-0623B48BD6B1"}
EOF

STRING_ESCAPED_PAYLOAD=$(jq -Rn '(input)' <<<"$PAYLOAD")

read -r -d '' CURL_PAYLOAD <<EOF
{
  "vhost": "/",
  "name": "amq.default",
  "properties": {
    "priority": 0,
    "delivery_mode": 2,
    "headers": {
      "X-Provider": "visa",
      "uber-trace-id": "1dc3fe998ff5e105:c4c6bcf4ce68dfb8:0:1"
    },
    "content_encoding": "utf-8",
    "content_type": "application/json"
  },
  "routing_key": "visa-auth",
  "delivery_mode": "2",
  "payload": ${STRING_ESCAPED_PAYLOAD},
  "headers": {},
  "props": {
    "content_type": "application/json"
  },
  "payload_encoding": "string"
}
EOF

curl -vv 'http://localhost:55673/api/exchanges/%2F/amq.default/publish' \
     -H 'Authorization: Basic Z3Vlc3Q6Z3Vlc3Q=' \
     -H 'Content-Type: application/json' \
     --data "${CURL_PAYLOAD}"

echo 'submitted visa auth payload\n'
