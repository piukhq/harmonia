#! /bin/bash

source s/_common

s/rmservices

p 'creating postgres'
docker run \
	-d \
	-p51235:5432 \
	--name txm-postgres \
	-e POSTGRES_HOST_AUTH_METHOD=trust \
	postgres

p 'creating pgbouncer'
docker run \
	-d \
	-p51234:51234 \
	--name txm-pgbouncer \
	-e DATABASES_HOST=$(ifconfig en0 | grep 'inet ' | cut -d' ' -f2) \
	-e DATABASES_PORT=51235 \
	-e DATABASES_USER=postgres \
	-e DATABASES_PASSWORD= \
	-e DATABASES_DBNAME=harmonia \
	-e PGBOUNCER_LISTEN_PORT=51234 \
	pgbouncer/pgbouncer

p 'creating redis'
docker run \
	-d \
	-p61234:6379 \
	--name txm-redis \
	redis

p 'giving postgres a chance to start'
sleep 3

p 'creating harmonia database'
docker exec -it txm-postgres psql -U postgres -c 'create database harmonia;'

s/migrate
