#! /bin/bash

source s/_common

s/rmservices

p 'creating postgres'
docker run \
	-d \
    --rm \
	-p51234:5432 \
	--name txm-postgres \
	-e POSTGRES_HOST_AUTH_METHOD=trust \
	postgres

p 'creating redis'
docker run \
	-d \
    --rm \
	-p61234:6379 \
	--name txm-redis \
	redis

p 'creating rabbitmq'
docker run \
	-d \
    --rm \
	-p55672:5672 \
	-p55673:15672 \
	--name txm-rabbitmq \
	rabbitmq:3-management

retries=3
for ((i=0; i<retries; i++)); do
    p 'creating harmonia database'
    docker exec -it txm-postgres psql -U postgres -c 'create database harmonia;' && \
    s/migrate
    [[ $? -eq 0 ]] && break

    p 'giving postgres a chance to start'
    sleep 3
done

(( retries == i )) && { p 'failed!'; exit 1; }
exit 0
